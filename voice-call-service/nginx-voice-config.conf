# Configuración adicional para Nginx - Sistema de Llamadas de Voz
# Agregar estas ubicaciones al archivo nginx-biosanarcall.conf existente

# Webhook de Zadarma para llamadas de voz
location /webhook/zadarma {
    proxy_pass http://127.0.0.1:3001/webhook/zadarma;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Configuración específica para webhooks
    proxy_read_timeout 30s;
    proxy_connect_timeout 10s;
    client_max_body_size 10M;
    
    # Headers de seguridad
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Accept $http_accept;
    
    # Log específico para webhooks de voz
    access_log /var/log/nginx/voice-webhook.log;
    error_log /var/log/nginx/voice-webhook-error.log;
}

# API del servicio de llamadas de voz
location /api/voice/ {
    proxy_pass http://127.0.0.1:3001/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Timeout más largo para procesamiento de audio
    proxy_read_timeout 60s;
    proxy_connect_timeout 10s;
    
    # Permitir archivos de audio grandes
    client_max_body_size 50M;
}

# Servir archivos de audio estáticos generados por TTS
location /audio/ {
    proxy_pass http://127.0.0.1:3001/audio/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Headers para archivos de audio
    add_header Content-Type audio/mpeg;
    add_header Cache-Control "public, max-age=3600";
    add_header Access-Control-Allow-Origin "*";
    
    # Timeout específico para descargas de audio
    proxy_read_timeout 30s;
}

# Health check del servicio de voz
location /api/voice-health {
    proxy_pass http://127.0.0.1:3001/health;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Respuesta rápida para health checks
    proxy_read_timeout 5s;
    proxy_connect_timeout 3s;
}

# Rate limiting específico para webhooks de voz
limit_req_zone $remote_addr zone=voice_webhook:10m rate=10r/m;

# Aplicar rate limiting al webhook de Zadarma
location /webhook/zadarma {
    limit_req zone=voice_webhook burst=5 nodelay;
    # ... resto de la configuración anterior
}

# Configuración adicional para logs de voz
log_format voice_format '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        'call_id="$http_x_call_id" '
                        'response_time=$request_time';

# Ejemplo de uso en la configuración principal:
# access_log /var/log/nginx/voice-calls.log voice_format;