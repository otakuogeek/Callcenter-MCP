<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biosanarcall - Agente de Voz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="voiceAgent()">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-blue-600 text-white p-3 rounded-lg">
                        <i class="fas fa-phone-alt text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Biosanarcall - Agente de Voz</h1>
                        <p class="text-gray-600">Sistema inteligente de llamadas con IA</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Estado del Sistema</div>
                        <div class="flex items-center space-x-2">
                            <div :class="systemStatus.color" class="w-3 h-3 rounded-full"></div>
                            <span x-text="systemStatus.text" class="font-medium"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Balance Zadarma -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Balance Zadarma</p>
                        <p x-text="balance" class="text-2xl font-bold text-green-600">$0.00</p>
                    </div>
                    <div class="bg-green-100 text-green-600 p-3 rounded-lg">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
            </div>

            <!-- Llamadas Hoy -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Llamadas Hoy</p>
                        <p x-text="callsToday" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-blue-100 text-blue-600 p-3 rounded-lg">
                        <i class="fas fa-phone"></i>
                    </div>
                </div>
            </div>

            <!-- Tiempo Promedio -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Tiempo Promedio</p>
                        <p x-text="avgDuration" class="text-2xl font-bold text-purple-600">0m 0s</p>
                    </div>
                    <div class="bg-purple-100 text-purple-600 p-3 rounded-lg">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>

            <!-- Éxito -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Tasa de Éxito</p>
                        <p x-text="successRate" class="text-2xl font-bold text-emerald-600">0%</p>
                    </div>
                    <div class="bg-emerald-100 text-emerald-600 p-3 rounded-lg">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Panel de Control -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-cogs mr-2"></i>Panel de Control
                </h2>

                <div class="space-y-4">
                    <!-- Test API Zadarma -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-semibold text-gray-700 mb-2">Test API Zadarma</h3>
                        <div class="flex space-x-2">
                            <button @click="testZadarmaAPI()" 
                                    :disabled="loading"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg disabled:opacity-50">
                                <i class="fas fa-play mr-2"></i>Probar API
                            </button>
                            <button @click="getBalance()" 
                                    :disabled="loading"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg disabled:opacity-50">
                                <i class="fas fa-dollar-sign mr-2"></i>Obtener Balance
                            </button>
                        </div>
                    </div>

                    <!-- Test Webhook -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-semibold text-gray-700 mb-2">Test Webhook</h3>
                        <div class="flex space-x-2">
                            <button @click="testWebhook()" 
                                    :disabled="loading"
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg disabled:opacity-50">
                                <i class="fas fa-webhook mr-2"></i>Test Webhook
                            </button>
                            <button @click="simulateCall()" 
                                    :disabled="loading"
                                    class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg disabled:opacity-50">
                                <i class="fas fa-phone-square mr-2"></i>Simular Llamada
                            </button>
                        </div>
                    </div>

                    <!-- Estado de Servicios -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-semibold text-gray-700 mb-2">Estado de Servicios</h3>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span>Servicio de Voz</span>
                                <div class="flex items-center space-x-2">
                                    <div :class="services.voice.color" class="w-2 h-2 rounded-full"></div>
                                    <span x-text="services.voice.status" class="text-sm"></span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span>Backend Principal</span>
                                <div class="flex items-center space-x-2">
                                    <div :class="services.backend.color" class="w-2 h-2 rounded-full"></div>
                                    <span x-text="services.backend.status" class="text-sm"></span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span>MCP Server</span>
                                <div class="flex items-center space-x-2">
                                    <div :class="services.mcp.color" class="w-2 h-2 rounded-full"></div>
                                    <span x-text="services.mcp.status" class="text-sm"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs y Actividad -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-list mr-2"></i>Actividad Reciente
                </h2>

                <div class="space-y-3 max-h-96 overflow-y-auto">
                    <template x-for="log in logs" :key="log.id">
                        <div class="border-l-4 pl-4 py-2" :class="log.borderColor">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium" x-text="log.message"></span>
                                <span class="text-xs text-gray-500" x-text="log.time"></span>
                            </div>
                            <div class="text-xs text-gray-600" x-text="log.details"></div>
                        </div>
                    </template>
                </div>

                <div class="mt-4 flex space-x-2">
                    <button @click="clearLogs()" class="text-sm text-gray-600 hover:text-gray-800">
                        <i class="fas fa-trash mr-1"></i>Limpiar
                    </button>
                    <button @click="refreshLogs()" class="text-sm text-gray-600 hover:text-gray-800">
                        <i class="fas fa-refresh mr-1"></i>Actualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- Historial de Llamadas -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-history mr-2"></i>Historial de Llamadas
            </h2>

            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Número</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duración</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="call in calls" :key="call.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="call.date"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="call.number"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="call.duration"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded-full" :class="call.statusColor" x-text="call.status"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button @click="viewCall(call)" class="text-blue-600 hover:text-blue-900 mr-3">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button @click="downloadRecording(call)" class="text-green-600 hover:text-green-900">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span>Procesando...</span>
            </div>
        </div>
    </div>

    <script>
        function voiceAgent() {
            return {
                loading: false,
                balance: '$0.00',
                callsToday: 0,
                avgDuration: '0m 0s',
                successRate: '0%',
                systemStatus: {
                    text: 'Verificando...',
                    color: 'bg-yellow-400'
                },
                services: {
                    voice: { status: 'Desconocido', color: 'bg-gray-400' },
                    backend: { status: 'Desconocido', color: 'bg-gray-400' },
                    mcp: { status: 'Desconocido', color: 'bg-gray-400' }
                },
                logs: [],
                calls: [],

                init() {
                    this.loadInitialData();
                    this.checkSystemStatus();
                    setInterval(() => this.checkSystemStatus(), 30000); // Check every 30 seconds
                },

                addLog(message, details = '', type = 'info') {
                    const colors = {
                        info: 'border-blue-400',
                        success: 'border-green-400',
                        warning: 'border-yellow-400',
                        error: 'border-red-400'
                    };

                    this.logs.unshift({
                        id: Date.now(),
                        message,
                        details,
                        time: new Date().toLocaleTimeString(),
                        borderColor: colors[type] || 'border-gray-400'
                    });

                    // Keep only last 50 logs
                    if (this.logs.length > 50) {
                        this.logs = this.logs.slice(0, 50);
                    }
                },

                async loadInitialData() {
                    this.addLog('Iniciando interfaz de agente de voz', 'Cargando datos iniciales...');
                    await this.getBalance();
                    await this.loadCallHistory();
                },

                async checkSystemStatus() {
                    try {
                        // Check voice service
                        const voiceResponse = await fetch('/api/voice/health');
                        this.services.voice = voiceResponse.ok 
                            ? { status: 'Online', color: 'bg-green-400' }
                            : { status: 'Offline', color: 'bg-red-400' };

                        // Check backend
                        const backendResponse = await fetch('/api/auth/health');
                        this.services.backend = (backendResponse.status === 200 || backendResponse.status === 401)
                            ? { status: 'Online', color: 'bg-green-400' }
                            : { status: 'Offline', color: 'bg-red-400' };

                        // Check MCP
                        const mcpResponse = await fetch('/mcp-py-health');
                        this.services.mcp = mcpResponse.ok
                            ? { status: 'Online', color: 'bg-green-400' }
                            : { status: 'Offline', color: 'bg-red-400' };

                        // Update system status
                        const allOnline = Object.values(this.services).every(s => s.color === 'bg-green-400');
                        this.systemStatus = allOnline
                            ? { text: 'Operativo', color: 'bg-green-400' }
                            : { text: 'Problemas', color: 'bg-red-400' };

                    } catch (error) {
                        this.addLog('Error verificando estado del sistema', error.message, 'error');
                        this.systemStatus = { text: 'Error', color: 'bg-red-400' };
                    }
                },

                async testZadarmaAPI() {
                    this.loading = true;
                    this.addLog('Probando API de Zadarma...', 'Verificando conectividad');

                    try {
                        const response = await fetch('/api/voice/test-zadarma', {
                            method: 'POST'
                        });
                        const result = await response.json();

                        if (response.ok) {
                            this.addLog('API de Zadarma: Éxito', `Respuesta: ${JSON.stringify(result)}`, 'success');
                        } else {
                            this.addLog('API de Zadarma: Error', result.error || 'Error desconocido', 'error');
                        }
                    } catch (error) {
                        this.addLog('Error probando API de Zadarma', error.message, 'error');
                    }

                    this.loading = false;
                },

                async getBalance() {
                    try {
                        const response = await fetch('/api/voice/balance');
                        const result = await response.json();

                        if (response.ok && result.success) {
                            this.balance = result.balance;
                            this.addLog('Balance actualizado', `Nuevo balance: ${this.balance}`, 'success');
                        } else {
                            this.addLog('Error obteniendo balance', result.error || 'Error desconocido', 'error');
                        }
                    } catch (error) {
                        this.addLog('Error obteniendo balance', error.message, 'error');
                    }
                },

                async testWebhook() {
                    this.loading = true;
                    this.addLog('Probando webhook...', 'Enviando evento de prueba');

                    try {
                        const response = await fetch('/webhook/zadarma', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                event: 'NOTIFY_START',
                                pbx_call_id: 'test_' + Date.now(),
                                caller: '+1234567890',
                                called_did: '+576076916019'
                            })
                        });

                        const result = await response.json();
                        if (response.ok) {
                            this.addLog('Webhook: Éxito', `Evento procesado correctamente`, 'success');
                        } else {
                            this.addLog('Webhook: Error', result.error || 'Error desconocido', 'error');
                        }
                    } catch (error) {
                        this.addLog('Error probando webhook', error.message, 'error');
                    }

                    this.loading = false;
                },

                async simulateCall() {
                    this.loading = true;
                    this.addLog('Simulando llamada...', 'Creando llamada de prueba');

                    try {
                        const response = await fetch('/api/voice/simulate-call', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                caller: '+1234567890',
                                called: '+576076916019'
                            })
                        });

                        const result = await response.json();
                        if (response.ok) {
                            this.addLog('Simulación: Éxito', `Llamada simulada creada`, 'success');
                            await this.loadCallHistory();
                        } else {
                            this.addLog('Simulación: Error', result.error || 'Error desconocido', 'error');
                        }
                    } catch (error) {
                        this.addLog('Error simulando llamada', error.message, 'error');
                    }

                    this.loading = false;
                },

                async loadCallHistory() {
                    try {
                        const response = await fetch('/api/voice/calls');
                        const result = await response.json();

                        if (response.ok && result.success) {
                            this.calls = result.calls.map(call => ({
                                ...call,
                                statusColor: call.status === 'completed' ? 'bg-green-100 text-green-800' :
                                           call.status === 'failed' ? 'bg-red-100 text-red-800' :
                                           'bg-yellow-100 text-yellow-800'
                            }));
                            this.callsToday = this.calls.filter(call => 
                                new Date(call.created_at).toDateString() === new Date().toDateString()
                            ).length;
                        }
                    } catch (error) {
                        this.addLog('Error cargando historial', error.message, 'error');
                    }
                },

                viewCall(call) {
                    this.addLog('Visualizando llamada', `Call ID: ${call.id}`, 'info');
                    // Implement call details modal
                },

                downloadRecording(call) {
                    this.addLog('Descargando grabación', `Call ID: ${call.id}`, 'info');
                    // Implement recording download
                },

                clearLogs() {
                    this.logs = [];
                    this.addLog('Logs limpiados', 'Historial de actividad reiniciado');
                },

                refreshLogs() {
                    this.addLog('Logs actualizados', 'Historial recargado manualmente');
                    this.checkSystemStatus();
                }
            }
        }
    </script>
</body>
</html>